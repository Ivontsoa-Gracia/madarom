<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Validation de devis</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class=" p-6 text-gray-800">
  <div class="max-w-3xl mx-auto bg-white p-6">

    <div class="mb-4" id="client">
      <h3 class="font-semibold mb-1">Client :</h3>
      <p class="text-sm" id="client-name">Nom</p>
      <p class="text-sm" id="client-email">Email</p>
    </div>

    <table class="w-full text-sm border-t border-b mb-4">
      <thead>
        <tr class="bg-gray-100 text-left">
          <th class="py-2 px-2">Produit</th>
          <th class="py-2 px-2 text-center">Quantité</th>
          <th class="py-2 px-2 text-right">Prix unitaire</th>
          <th class="py-2 px-2 text-right">Total</th>
        </tr>
      </thead>
      <tbody id="quotes-items"></tbody>
    </table>

    <div class="mt-4 flex justify-end">
      <table class="text-sm w-1/2">
        <tr>
          <td class="text-right font-semibold">Sous-total :</td>
          <td class="text-right" id="subtotal"></td>
        </tr>
        <!-- <tr>
          <td class="text-right font-semibold">TVA (20%) :</td>
          <td class="text-right" id="tva"></td>
        </tr> -->
        <tr>
          <td class="text-right font-bold text-teal-600">Total TTC :</td>
          <td class="text-right font-bold text-teal-600" id="total"></td>
        </tr>
      </table>
    </div>

    <!-- Validation form -->
    <div class="mt-8 border-t pt-4">
      <label for="delivery-date" class="block mb-1 font-medium">Date estimée de livraison :</label>
      <input type="number" id="delivery-date" class="border rounded px-3 py-2 w-full max-w-xs mb-4" />

      <button id="validate-btn" class="bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700">
        Valider la demande
      </button>
    </div>

    <!-- Message -->
    <p id="status-message" class="mt-4 text-sm text-center"></p>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script>
    function generatePDF() {
      const element = document.querySelector('.max-w-3xl');
      const options = {
        margin: 0.5,
        filename: 'devis.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().set(options).from(element).save();
    }

    function formatPrice(val) {
      return new Intl.NumberFormat("fr-FR", {
        style: "currency",
        currency: "MGA"
      }).format(val);
    }

    const token = localStorage.getItem("token");
    const ref = new URLSearchParams(window.location.search).get("ref");

    async function loadQuoteData(id) {
      try {
        const res = await fetch(`http://127.0.0.1:8000/api/quote/${id}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!res.ok) throw new Error("Devis non trouvé");

        const quote = await res.json();
        // document.getElementById("quote-number").textContent = `N° ${quote.quote_number}`;
        document.getElementById("client-name").textContent = quote.user.name;
        document.getElementById("client-email").textContent = quote.user.email;

        const tbody = document.getElementById("quotes-items");
        let total = 0;
        tbody.innerHTML = "";
        quote.items.forEach(item => {
          const sub = item.price_snapshot * item.quantity;
          total += sub;
          tbody.innerHTML += `
            <tr>
              <td class="py-2 px-2">${item.product.name_en}</td>
              <td class="py-2 px-2 text-center">${item.quantity}</td>
              <td class="py-2 px-2 text-right">${formatPrice(item.price_snapshot)}</td>
              <td class="py-2 px-2 text-right">${formatPrice(sub)}</td>
            </tr>`;
        });

        const tva = total * 0.2;
        // const ttc = total + tva;
        const ttc = total;
        document.getElementById("subtotal").textContent = formatPrice(total);
        // document.getElementById("tva").textContent = formatPrice(tva);
        document.getElementById("total").textContent = formatPrice(ttc);
      } catch (error) {
        console.error("Erreur chargement devis:", error);
        alert("Erreur de chargement.");
      }
    }

    document.getElementById("validate-btn").addEventListener("click", async () => {
      const date = document.getElementById("delivery-date").value;
      const statusMsg = document.getElementById("status-message");

      if (!date) {
        statusMsg.textContent = "Veuillez indiquer une date de livraison estimée.";
        statusMsg.className = "text-red-500 text-sm text-center mt-2";
        return;
      }

      try {
        const res = await fetch(`http://127.0.0.1:8000/api/quote/valide`, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            quote_id: ref,
            estimated_delivery_date: date
          })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.message || "Erreur de validation");

        statusMsg.textContent = "✔️ Demande validée avec succès !";
        statusMsg.className = "text-green-600 text-sm text-center mt-2";
      } catch (err) {
        console.error(err);
        statusMsg.textContent = "❌ Erreur lors de la validation.";
        statusMsg.className = "text-red-500 text-sm text-center mt-2";
      }
    });

    if (ref && token) loadQuoteData(ref);
    else alert("Aucun ID de devis ou token manquant.");
  </script>
</body>
</html>
