<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>User Quotes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#AB1A17',
            secondary: '#AAC2AE',
            success: '#65A67A',
            warning: '#F4D35E',
            danger: '#E63946',
            background: '#FCFFFC',
            text: '#2F2F2F'
          }
        }
      }
    }
  </script>
</head>
<body class="bg-background text-text font-sans">
  <div class="max-w-5xl mx-auto py-10 px-4">
    <!-- Header -->
    <div class="flex items-center justify-between mb-10">
      <h1 class="text-4xl font-bold text-primary">Quotes</h1>
      <button onclick="fetchQuotes()" class="bg-secondary text-text px-4 py-2 rounded-lg shadow hover:brightness-95">
        Refresh
      </button>
    </div>

    <!-- Filter Card -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 bg-white p-6 rounded-2xl shadow mb-8">
      <div>
        <label class="block mb-1 text-sm font-medium">Date</label>
        <input type="date" id="filterDate" class="w-full border border-secondary rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" />
      </div>
      <div>
        <label class="block mb-1 text-sm font-medium">Sort</label>
        <select id="sortOrder" class="w-full border border-secondary rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
          <option value="desc">Newest First</option>
          <option value="asc">Oldest First</option>
        </select>
      </div>
      <div>
        <label class="block mb-1 text-sm font-medium">Status</label>
        <select id="statusFilter" class="w-full border border-secondary rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
          <option value="">All</option>
          <option value="pending">Pending</option>
          <option value="validated">Validated</option>
          <option value="refused">Refused</option>
        </select>
      </div>
    </div>

    <!-- Quotes Table -->
    <div class="bg-white rounded-2xl shadow overflow-hidden">
      <table class="w-full text-left">
        <thead class="bg-primary text-white text-sm">
          <tr>
            <th class="py-3 px-6">Quote #</th>
            <th class="py-3 px-6">Status</th>
            <th class="py-3 px-6">Date</th>
            <th class="py-3 px-6 text-right">Actions</th>
          </tr>
        </thead>
        <tbody id="quotesBody" class="divide-y divide-gray-100 bg-white text-sm">
          <!-- Dynamic rows -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    let allQuotes = [];

    const tbody = document.getElementById('quotesBody');
    const filterDate = document.getElementById('filterDate');
    const sortOrder = document.getElementById('sortOrder');
    const statusFilter = document.getElementById('statusFilter');

    const renderStatusBadge = (status) => {
      const base = "px-2 py-1 rounded-full text-xs font-medium";
      switch (status) {
        case "validated":
          return `<span class="${base} bg-success/10 text-success">Validated</span>`;
        case "pending":
          return `<span class="${base} bg-warning/10 text-yellow-800">Pending</span>`;
        case "refused":
          return `<span class="${base} bg-danger/10 text-danger">Refused</span>`;
        default:
          return `<span class="${base} bg-gray-200 text-gray-600">${status}</span>`;
      }
    }

    const renderQuotes = (data) => {
      tbody.innerHTML = '';
      if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-center py-6 text-gray-500">No quotes available.</td></tr>`;
        return;
      }

      data.forEach(q => {
        tbody.innerHTML += `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 font-medium">${q.quote_number || 'N/A'}</td>
            <td class="px-6 py-4">${renderStatusBadge(q.status)}</td>
            <td class="px-6 py-4">${q.created_at?.split('T')[0]}</td>
            <td class="px-6 py-4 text-right">
              <button onclick="viewQuote('${q.id}')" class="bg-primary text-white text-sm px-3 py-1.5 rounded-lg hover:bg-[#8c1514]">View</button>
            </td>
          </tr>
        `;
      });
    }

    const applyFilters = () => {
      let filtered = [...allQuotes];
      const dateVal = filterDate.value;
      const sort = sortOrder.value;
      const statusVal = statusFilter.value;

      if (dateVal) filtered = filtered.filter(q => q.created_at.startsWith(dateVal));
      if (statusVal) filtered = filtered.filter(q => q.status === statusVal);

      filtered.sort((a, b) => {
        const dA = new Date(a.created_at);
        const dB = new Date(b.created_at);
        return sort === 'desc' ? dB - dA : dA - dB;
      });

      renderQuotes(filtered);
    }

    async function fetchQuotes() {
      const token = localStorage.getItem("token");
      if (!token) return alert("No token found. Please log in.");

      try {
        const res = await fetch("http://127.0.0.1:8000/api/quote", {
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });
        if (!res.ok) throw new Error("Fetch failed");
        const data = await res.json();
        allQuotes = data;
        applyFilters();
      } catch (err) {
        console.error(err);
        alert("Error fetching quotes.");
      }
    }

    function viewQuote(id) {
      if (!id) return;
      window.location.href = `quote_pdf.html?ref=${encodeURIComponent(id)}`;
    }

    filterDate.addEventListener('input', applyFilters);
    sortOrder.addEventListener('change', applyFilters);
    statusFilter.addEventListener('change', applyFilters);

    fetchQuotes();
  </script>
</body>
</html>